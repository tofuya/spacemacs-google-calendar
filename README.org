#+TITLE: google-calendar layer
#+STARTUP: overview

* Description
This layer provides Google Calendar integration for Spacemacs using
~org-gcal~ and ~calfw~.

It allows you to:
- Sync Google Calendar events into Org files
- View calendars using calfw (day / week / month views)
- Open specific calendar files or the current Org buffer in calfw
- Post and delete calendar entries from Org
- Insert org-gcal posting skeletons interactively

* Features
- Declarative calendar configuration via ~google-calendar-calendars~
- calfw-based visual calendar UI
- Evil-friendly keybindings in ~calfw-calendar-mode~
- Structured leader-key hierarchy under ~SPC a g~
- Interactive calendar selection for org-gcal posting

* Installation
This layer is intended to be used as a private Spacemacs layer.

1. Place this directory under:
   =~/.spacemacs.d/layers/google-calendar/=

   For example:

   #+BEGIN_SRC sh
   git clone https://github.com/tofuya/spacemacs-google-calendar.git \
     ~/.spacemacs.d/layers/google-calendar
   #+END_SRC

2. Add the layer to ~dotspacemacs-configuration-layers~:

#+BEGIN_SRC emacs-lisp
google-calendar
#+END_SRC

This layer depends on:
- org-gcal
- calfw (using the develop branch)

* Google Calendar setup (org-gcal)
This layer relies on ~org-gcal~ and requires initial setup using
Google Developers Console.

You must:
1. Create a project in Google Developers Console
2. Enable the Google Calendar API
3. Create OAuth 2.0 credentials
4. Configure ~org-gcal-client-id~ and ~org-gcal-client-secret~

Please follow the official org-gcal setup guide:
https://github.com/kidd/org-gcal.el#installation

After completing the setup, calendar synchronization can be triggered via:
~SPC a g s f~

* Configuration
** Calendar definitions
Calendars are configured via ~google-calendar-calendars~.

Each entry is a plist with:
- ~:label~ — short identifier used for commands and UI
- ~:calendar-id~ — Google Calendar ID
- ~:file~ — Org file to sync events into

Example:

#+BEGIN_SRC emacs-lisp
(setq google-calendar-calendars
      '((:label "timeblocks"
         :calendar-id "your-calendar-id@gmail.com"
         :file "~/org/gcal-timeblocks.org")
        (:label "fixed"
         :calendar-id "another-id@group.calendar.google.com"
         :file "~/org/gcal-fixed.org")))
#+END_SRC

The configuration is automatically applied to ~org-gcal-file-alist~
when ~org-gcal~ is loaded.

** Auto-generated open commands
This layer automatically generates interactive commands to open
calendar org files based on ~google-calendar-calendars~.

Commands are created after ~dotspacemacs/user-config~ executes,
using the following naming pattern:

- ~google-calendar-open-<label>~

Example:

#+BEGIN_SRC emacs-lisp
;; Only configuration is required
(setq google-calendar-calendars
      '((:label "timeblocks"
         :calendar-id "xxx@gmail.com"
         :file "~/org/gcal-timeblocks.org")
        (:label "fixed"
         :calendar-id "yyy@group.calendar.google.com"
         :file "~/org/gcal-fixed.org")))

;; Commands are generated automatically:
;; google-calendar-open-timeblocks
;; google-calendar-open-fixed
#+END_SRC

No manual invocation of ~google-calendar-define-open-commands~ is needed.

* Posting events to Google Calendar
This layer provides a helper command to quickly prepare an Org entry
for posting to Google Calendar using ~org-gcal~.

Instead of manually writing required properties, you can insert a
pre-filled posting skeleton and select the target calendar interactively.

** Insert org-gcal posting skeleton
Run the following command at the heading you want to post:

~SPC a g e i~
or
~M-x google-calendar-insert-org-gcal-skeleton~

This will:
1. Prompt you to select a calendar (based on ~google-calendar-calendars~)
2. Insert the required ~org-gcal~ properties automatically

The inserted skeleton looks like this:

#+BEGIN_SRC org
:PROPERTIES:
:calendar-id: <selected-calendar-id>
:org-gcal-managed: org
:END:
:org-gcal:

:END:
#+END_SRC

After filling in the entry contents, you can post it using:

~SPC a g e p~

** Notes
- The calendar list is derived from ~google-calendar-calendars~
- This command is optional but recommended for consistent org-gcal usage

* Key bindings
All commands are under the ~SPC a g~ prefix.

** View
| Key | Description |
|-----+-------------|
| ~SPC a g v g~ | Select a Google Calendar and show it in calfw |
| ~SPC a g v f~ | Show a specific Org file in calfw |
| ~SPC a g v .~ | Show current Org buffer in calfw |

** Open
| Key | Description |
|-----+-------------|
| ~SPC a g o f~ | Open a calendar Org file |

** Sync
| Key | Description |
|-----+-------------|
| ~SPC a g s f~ | Fetch events from Google Calendar |
| ~SPC a g s r~ | Reload OAuth client ID and secret |

** Entry
| Key | Description |
|-----+-------------|
| ~SPC a g e p~ | Post Org entry at point to Google Calendar |
| ~SPC a g e d~ | Delete Google Calendar entry at point |
| ~SPC a g e i~ | Insert org-gcal posting skeleton |

* calfw Evil keybindings
When viewing calendars in ~calfw-calendar-mode~, the following Evil
normal-state bindings are available:

** Navigation
| Key | Action |
|-----+--------|
| h / l | Previous / next day |
| k / j | Previous / next week |
| K / J | Previous / next month |
| ^ / $ | Week begin / end |

** View control
| Key | Action |
|-----+--------|
| H / L | Move timeline |
| t | Go to today |
| g | Go to specific date |

** View modes
| Key | Action |
|-----+--------|
| M | Month view |
| W | Week view |
| T | Two-week view |
| D | Day view |

** Actions
| Key | Action |
|-----+--------|
| TAB | Next item |
| RET | Open item |
| SPC | Show details |
| r | Refresh |
| q | Quit calendar |

* Notes
- OAuth credentials must be configured for ~org-gcal~ beforehand.
- Initial sync may take some time depending on calendar size.
- All commands are generated and bound by the layer; no user-side
  function calls are required.
